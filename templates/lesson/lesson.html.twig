{% extends 'responsive.html.twig' %}

{% block title %}{{ parent() }} - Feuille d'appel{% endblock %}

{% block body %}
        <div class="table-wrapper center">
            <a href="{{ path('lesson_index') }}"> &lt -- Retourn à la liste des créneaux</a>
            <div>
                <div class="table-title" >
                    <h1>Feuille d'appel</h1>
                </div>
                <div>
                    <p>{{ lesson.name }} - {{lesson.classGroup.name}}</p>
                    <p>{{ lesson.dateStart|date('d-m-Y h:m') }} à {{ lesson.dateEnd|date('d-m-Y h:m') }}</p>
                </div>
            </div>
            <div>
                <table class="table table-bordered center">
                    <thead>
                        <tr class="line-rollcall">
                            <th >Etudiant</th>
                            <th >Présent</th>
                            <th >Absent</th>
                            <th >Retard</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in lesson.classGroup.students %}
                            {% set presence = null %}
                            {% if lesson.studentPresences != null %}
                                {% for pres in lesson.studentPresences %}
                                    {% if pres.student.id == student.id %}
                                        {% set presence = pres %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            <tr class="line-rollcall">
                                <form class="formPresence" method="POST" action="{{ path('lesson/new') }}">
                                    <td >
                                        {{student.firstname ~ ' ' ~ student.lastname}} 
                                        <input type="hidden" name="id_student" value={{student.id}} />
                                        <input type="hidden" name="id_lesson" value={{lesson.id}} />
                                    </td>
                                    {% if presence != null and presence.present == true %}
                                        <td >
                                            <input type="radio" class="radio" id={{"presentRadio" ~ student.id}} name="present" value="true" checked/>
                                        </td>
                                        <td >
                                            <input type="radio" class="radio" id={{"absentRadio" ~ student.id}} name="present" value="false" />
                                        </td>
                                        {% if presence.late != null %}
                                            {% set late = date(presence.late).diff(date(lesson.dateStart))%}
                                            <td >
                                                <input type="number" id={{"late" ~ student.id}} class="inputNumber" name="late" value={{late.i}} min=0 />
                                            </td>
                                        {% else %}
                                            <td >
                                                <input type="number" id={{"late" ~ student.id}} class="inputNumber" name="late" value=0 min=0 />
                                            </td>
                                        {% endif %}
                                    {% else %}
                                        <td >
                                            <input type="radio" class="radio" id={{"presentRadio" ~ student.id}} name="present" value="true" />
                                        </td>
                                        <td >
                                            <input type="radio" class="radio" id={{"absentRadio" ~ student.id}} name="present"  value="false" checked/>
                                        </td>
                                        <td >
                                            <input type="number" class="inputNumber" id={{"late" ~ student.id}} name="late" value=0 min=0 disabled/>
                                        </td>
                                    {% endif %}
                                </form>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button id="submit" class="btn btn-primary margin10">Valider</button>
            </div>
        </div>
    <script>
        $('#submit').click(function (){
            $(".formPresence").each(function(){
                console.log("sendFormPresence each", this);
                $.ajax({
                    type: "POST",
                    url: "new",
                    data: $(this).serialize(),
                });
            })
            alert("Appel enregistré");
        })

        $(".radio").click(function(){
            var id = $(this).attr('id');
            if(id.indexOf("presentRadio") == 0){
                var idField = id.replace("presentRadio", "late");
                console.log("presentRadio", idField, $('#'+idField));
                $('#'+idField).prop("disabled", false);
            }
            else if(id.indexOf("absentRadio") == 0){
                var idField = id.replace("absentRadio", "late");
                console.log("absentRadio", idField, $('#'+idField))
                $('#'+idField).prop("disabled", true);
                $('#'+idField).prop("value", 0);
            }
        })
    </script>
{% endblock %}
